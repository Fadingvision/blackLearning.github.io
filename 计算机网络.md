# 计算机网络

## 浏览器工作原理

![](https://segmentfault.com/img/bVWhRl?w=801&h=814)

[howbrowserswork](https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/)

## 应用层(HTTP, FTP, SMTP)

### HTTP

TCP连接的socket API:

![](https://files.realpython.com/media/sockets-tcp-flow.1da426797e37.jpg)

### HTTP2

在 HTTP/1.x 中，如果客户端要想发起多个并行请求以提升性能，则必须使用多个 TCP 连接（请参阅使用多个 TCP 连接）。 这是 HTTP/1.x 交付模型的直接结果，该模型可以保证每个连接每次只交付一个响应（响应排队）。 更糟糕的是，这种模型也会导致队首阻塞，从而造成底层 TCP 连接的效率低下。

HTTP/2 中新的二进制分帧层突破了这些限制，实现了完整的请求和响应复用：客户端和服务器可以将 HTTP 消息分解为互不依赖的帧，然后交错发送，最后再在另一端把它们重新组装起来。

HTTP/2 的三个概念：

- 数据流：已建立的连接内的双向字节流，可以承载一条或多条消息。
- 消息：与逻辑请求或响应消息对应的完整的一系列帧。
- 帧：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流。

这些概念的关系总结如下：

所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。
每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。
每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧。
帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。


数据流优先级

将 HTTP 消息分解为很多独立的帧之后，我们就可以复用多个数据流中的帧，客户端和服务器交错发送和传输这些帧的顺序就成为关键的性能决定因素。 为了做到这一点，HTTP/2 标准允许每个数据流都有一个关联的权重和依赖关系：

可以向每个数据流分配一个介于 1 至 256 之间的整数。
每个数据流与其他数据流之间可以存在显式依赖关系。
数据流依赖关系和权重的组合让客户端可以构建和传递“优先级树”，表明它倾向于如何接收响应。 反过来，服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端。

















### SSL/TLS

TLS握手：

第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。

第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。

第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。

第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。

第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成"对话密钥"（session key），用来加密接下来的整个对话过程。


为什么一定要用三个随机数，来生成"会话密钥":

> "不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。

> 对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。

> pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。"


### SSL连接的复用

有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。

session ID： 每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的"对话密钥"，而不必重新生成一把。

session ticket： 发送一个服务器在上一次对话中发送过来的session ticket。这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。

## TCP

运输层的作用：将网络层所提供的主机到主机交付服务扩展到为主机上运行的应用程序所提供的进程到进程交付服务。

1. 可靠数据传输
2. 拥塞控制


### TCP报文首部

- 序号字段(32b)和确认号字段(32b): 用于发送方和接收方实现可靠数据传输
- 接收窗口(16b): 用于流量控制，指示接收方愿意接受的字节数量
- 首部长度(4b): TCP首部的长度
- 选项字段：用于双方协商最大报文段长度
- 标志位(6b): 

  ACK用于指示确认字段的值使有效的。
  RST、SYN、FIN比特用于建立连接和拆除
  PSH比特被设置，指示接收方应立即将数据交给应用层
  URG比特用于指示报文段存在'紧急'数据。

### 三次握手


1. 客户机首先发送一个图书的TCP报文端

一个标志位(SYN)被设为1，因此该报文段被称为SYN报文段。另外，客户机会选择一个起始序号(client_isn),并将其防止到该报文端的序号字段中。 序号字段以及确认号字段由于保证tcp的可靠交付。

2. 服务器用另一个特殊的TCP报文端来响应。

服务器会从该数据包中提取出SYN报文端，为该TCP连接分配缓存和变量，并向客户机发送允许连接的报文段。

这个报文段包含三个重要的信息： 

  - SYN比特被设置为1
  - 确认号字段被设置为client_isn+1，表示已经接收到了起始序号，现在期望接受到client_isn+1的序列号，
  - 选择服务端的初始序号(server_isn)并将其放置到序号字段中。


3. 最后，客户机再用第三个特殊报文段作为响应。

由于TCP是全双工的连接，在收到服务器的允许连接之后，客户端也要给该链接分类缓存和变量。
然后想服务器发送一个报文段，将SYN比特设置为0(表示连接已经建立)，确认字段设为(server_isn+1)。


前两个报文段不承载“有效载荷(payload)”，也就是不含应用层的数据，而第三个报文段可以承载有效载荷。

### 四次挥手


1. TCP客户端发送FIN=1的特殊的报文段表示关闭连接
2. 服务端回送一个确认报文段
3. TCP服务端发送FIN=1的特殊的报文段表示关闭连接
4. 客户端回送一个确认报文段


### UDP

不提供任何可靠传输服务，首部只包含简单的校验和和传输需要的源和目的IP地址和端口号



### 网络层

- 校验和
- 转发和选路
- 拆分和组装数据包


#### IP数据包首部：

- 版本号(4 byte): 规定了该数据包使用的Ip协议版本，不同版本使用不同的数据包格式
- 首部长度(4b): 主要用于确定数据包的数据部分从哪里开始
- 服务类型：(TOS)比特用来使不同类型的IP数据包能互相区分开来。
- 数据包长度： 数据包长度的总长度，以字节计。
- 标识、标志、位偏移。与IP分片有关.

  标识：同一数据的不同分片的标识应为一致。
  标志： flag = 1表示非最后一帧，为0表示最后一帧
  位偏移：表示该帧的数据距离起始帧的位置偏移。(以8字节为单位)

- 寿命：(time-to-live)ttl字段用来确保数据包永远不会在网络中循环（例如长时间的选路循环），每当数据包经过一个路由器时，该字段的值减1.若为0时，则该数据包必须丢弃。
- 协议：当数据包到达目的地时候，该字段值指明了数据包的数据部分要交给哪个运输层协议。协议号将网络层与运输层绑定在一起，而端口号将运输船和应用层绑定在一起。
- 首部校验和：用于帮助路由器检测收到的数据包中的比特错误。
- 源和目的的IP地址。
- 选项：用于扩展
- 数据(payload): 交付给运输层的数据包。例如TCP，UDP, ICMP.



如果一个链路层所能承载的最带数据量（最大传输单元MTU）小于IP数据包的大小，则IP数据包的数据必须被分片成两个或更多个较小的数据包，然后将其用链路层帧封装，输出到链路上，这些较小的数据包叫做片/帧(fragment)。





#### 主机如何得到自己的IP地址，子网掩码，DNS服务器？


1. 网络管理员想ISP申请一块地址
2. 用DHCP(动态地址配置协议)向每个接入的主机分配一个IP地址。利用DHCP，主机可以自动的获取IP地址。


IPv4地址分为A、B、C、D、E五类，出去特殊作用的D、E两类，剩下的A、B、C三类地址是我们常见的IP地址段。A类地址的容量最大，可以容纳16777214个主机，B类地址可以容纳65534个主机，C类地址可以容纳254个主机。在这三类地址中，绝大多数的IP地址都是公有地址，需要向国际互联网信息中心申请注册。但是在IPv4地址协议中预留了3个IP地址段，作为私有地址，供组织机构内部使用。这三个地址段分别位于A、B、C三类地址内：

- A类地址：10.0.0.0--10.255.255.255
- B类地址：172.16.0.0--172.31.255.255 
- C类地址：192.168.0.0--192.168.255.255

所以局域网在选取使用私有地址时，一般会按照实际需要容纳的主机数来选择私有地址段。常见的局域网由于容量小，一般选择C类的192.168.0.0作为地址段使用，一些大型企业就需要使用B类甚至A类地址段作为内部网络的地址段。



#### ICMP协议(互联网控制报文协议)

ICMP协议主要用于主机和路由器交换网络层信息，ping 命令就是使用了ICMP协议来检查两台主机之间是否能够正确的传输IP数据包。


### 选路与转发

一台主机通常直接与第一台路由器相连，该路由器即为默认路由器，又称为该主机的第一跳路由器。每当某主机发送一个分组时，该分组都被传送给它的默认路由器。我们将原主机的默认路由器成为源路由器，目的主机的默认路由器称为目的路由器，选路即为为一个数据包从源主机传送到目的主机选路的问题。 

转发是在一个路由器之中，路由器根据其转发表决定将数据包发送到哪个接口的操作。

### IP术语


- 数据包（packet）：IP 协议传送数据的单位；
- 帧（frame）：链路层传送数据的单位；
- 节点（node）：实现了 IP 协议的设备；
- 路由器（router）：可以转发不是发给自己的 IP 包的设备；
- 主机（host）：不是路由器的节点；
- 链路（link）：一种通信机制或介质，节点可以通过它在链路层通信。比如以太网、PPP 链接，也包括隧道；
- 接口（interface）：节点与链路的连接（可以理解为抽象的“网卡”）；
- 链路层地址（link-layer address）：接口的链路层标识符（如以太网的 mac 地址）；


公司局域网里，PC通过DHCP服务器拿到IP/mask/默认网关

DNS后缀： 56qq.int

IP/子网掩码：10.250.123.226/255.255.248.0

子网掩码是用来判断任意两台计算机的ip地址是否属于同一子网络的根据。

IP地址=网络地址+主机地址

10.250.123.226 = 10.250.120.0 + 3.226

子网段：10.250.120.0 —— 10.250.127.255

网关的IP地址是具有路由功能的设备的IP地址，具有路由功能的设备有路由器、启用了路由协议的服务器（实质上相当于一台路由器）、代理服务器（也相当于一台路由器）。
默认网关的意思是一台主机如果找不到可用的网关，就把数据包发给默认指定的网关，由这个网关来处理数据包。现在主机使用的网关，一般指的是默认网关。

默认网关： 10.250.120.1


## 链路层

链路层主要是现在网络适配器(网卡)与CPU的软件上。主要服务有：

- 成帧
- 链路接入
- 可靠交付
- 流量控制
- 差错检测
- 差错纠正


### MAC地址

每个主机或路由器的网卡都有一个链路层的地址，即mac地址。

mac地址长度为6字节，通常用16进制表示法，每个字节表示为一对十六进制数。
mac地址一般被设计为永久的。

### 地址解析协议ARP

为了构造目的主机的链路层帧，主机必须向其网卡提供目的节点的MAC地址。
发送节点会通过目的节点的IP地址在ARP中转换得到其MAC地址。

其功能与DNS类似，但是ARP只会在同一个子网上的节点解析MAC地址。

每个节点(路由器或主机)的ARP模块都会在自身的RAM中维护一个ARP表，包含IP地址到MAC地址的映射。如果在这个表中没有找到，则会指示网卡用MAC广播地址(FF-FF-FF-FF-FF-FF)来发送一个ARP报文，从而子网中的所有节点都会收到该报文，从而检查自身的IP地址是否匹配，然后给查询节点发送一个带有所希望映射的响应ARP分组报文。然后源节点可以更新其ARP表，并发送IP数据包。

如果需要在不同子网中发送帧，由于ARP只在子网中生效，因此需要通过路由器进行转发。
即主机将IP数据包通过网卡发送到路由器，由路由器决定向哪个接口进行转发(转发表)，然后将其发送对应的目的子网中，得到目的主机适配器的MAC地址。

#### 以太网帧

- 数据字段：46-1500字节，承载IP数据包
- 目的mac地址(6字节)： 目的网卡的mac地址
- 源mac地址(6字节)
- 类型字段(2字节)： 表明该帧所支持的上层网络层协议，例如IP协议，ARP协议。同IP数据包中的协议字段，TCP协议中的端口号类似
- 循环冗余检测(4字节)：用于差错检测



## 计算机安全

- 对称加密（双方首先需要知道密钥）
- 公开密钥加密

A用已知的公钥来进行加密，B用私钥来进行解密，常用的加密算法为RSA算法。

由于RSA算法所消耗的时间远大于DES等对称加密算法。因此两者常常结合在一起使用

例如 A用RSA算法来将对称加密的密钥进行加密传递给B，此后双方就可以通过DES进行加密传输了。

为了使公钥通信得到认证，通信方需要确认公钥确实来自于需要进行通信的实体(路由器，浏览器等), 这通常由认证中心CA来完成，CA的职责就是验证身份和发行证书。

一旦CA验证了某个实体的身份，这个CA生成了一个把其身份和公钥绑定起来的证书。





























